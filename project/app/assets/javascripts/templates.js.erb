var Templates = [];

<% dir = Rails.root.join('app','templates').to_s + "/"  %>
<% Dir.glob( dir + "**/*").entries.select{|f| File.file?(f)}.each do |file| %>
  <% tokens = file.gsub(dir,'').split('/') %>
  <% name   = tokens[-1].split('.')[0].gsub(/^_/,'') %>
  <% path   = tokens[0...-1].join('/') %>

  Templates['<%= [path,name].compact.join("/") %>'] = function(obj){
    var template = <%= File.open(file).read.inspect %>
    Mustache.parse(template)
    return Mustache.render(template, obj)
  }
<% end %>
